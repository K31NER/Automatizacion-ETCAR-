<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ETCAR</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="icon" href="/static/img/logo.png" type="image/png">
    <style>
        .login-card {
            max-width: 400px;
            min-width: 300px;
        }
        .password-toggle {
            right: 12px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .password-toggle:hover {
            color: #2F855A; /* green-700 */
        }
        /* Estilo para el spinner de carga */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); /* Borde más claro para contraste con botón verde */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #fff; /* Color del spinner */
            animation: spin 1s ease infinite;
            display: inline-block; 
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-green-50 min-h-screen flex items-center justify-center p-4">
    <div class="login-card bg-white rounded-2xl shadow-xl w-full p-8 space-y-6">
        <!-- Encabezado -->
        <div class="text-center space-y-3">
            <div class="flex items-center justify-center space-x-2">
                <img src="/static/img/logo.png" alt="Logo ETCAR" class="w-20 h-20">
                <h1 class="text-2xl font-bold text-green-800">ETCAR</h1>
            </div>
            <p class="text-green-600">Sistema de Gestión de Mantenimiento</p>
        </div>

        <!-- Formulario Login -->
        <form id="loginForm" class="space-y-4">
            <!-- Usuario -->
            <div class="space-y-1">
                <label for="username" class="block text-sm font-medium text-green-700">Usuario</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                    </div>
                    <input 
                        type="text" 
                        id="username"
                        name="username"
                        required 
                        class="w-full pl-10 pr-4 py-2 border-2 border-green-100 rounded-lg focus:ring-2 focus:ring-green-500"
                        placeholder="Nombre de usuario"
                    >
                </div>
            </div>

            <!-- Contraseña -->
            <div class="space-y-1">
                <label for="password" class="block text-sm font-medium text-green-700">Contraseña</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                    </div>
                    <input 
                        type="password" 
                        id="password"
                        name="password"
                        required 
                        class="w-full pl-10 pr-12 py-2 border-2 border-green-100 rounded-lg focus:ring-2 focus:ring-green-500"
                        placeholder="••••••••"
                    >
                    <button 
                        type="button" 
                        class="password-toggle absolute inset-y-0 right-0 flex items-center pr-3"
                        onclick="togglePassword()"
                        aria-label="Mostrar u ocultar contraseña"
                    >
                        <svg id="eye-icon" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Área de Mensajes de Error -->
            <div id="messageArea" class="text-sm text-center">
                <!-- Mensajes de error del login -->
            </div>

            <!-- Botón de Acceso -->
            <button 
                type="submit" 
                id="loginButton"
                class="w-full flex items-center justify-center py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
            >
                <span id="buttonText">Iniciar Sesión</span>
                <span id="buttonSpinner" class="spinner hidden"></span>
            </button>
        </form>
    </div>

    <script>
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eye-icon');
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeIcon.innerHTML = isPassword ? `
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
            ` : `
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            const messageArea = document.getElementById('messageArea');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // --- 1. Cambiar estado del botón a "cargando" ---
                loginButton.disabled = true;
                buttonText.textContent = 'Ingresando...';
                buttonSpinner.classList.remove('hidden');
                messageArea.textContent = '';
                messageArea.className = 'text-sm text-center';

                // --- 2. Recolectar datos del formulario ---
                // FastAPI espera los datos de login (OAuth2PasswordRequestForm) como 'application/x-www-form-urlencoded'
                // por lo que usamos URLSearchParams en lugar de JSON.stringify para el body.
                const formData = new FormData(loginForm);
                const bodyData = new URLSearchParams();
                formData.forEach((value, key) => {
                    bodyData.append(key, value);
                });
                
                console.log('Datos a enviar (form-urlencoded):', bodyData.toString());

                // --- 3. Realizar la petición FETCH al backend ---
                try {
                    // =================================================================
                    // MODIFICAR AQUÍ: URL del endpoint de login de tu backend FastAPI.
                    // Este endpoint típicamente espera un POST con 'username' y 'password'.
                    // Ejemplo: const LOGIN_API_ENDPOINT_URL = 'http://localhost:8000/api/v1/auth/token';
                    const LOGIN_API_ENDPOINT_URL = '/api/v1/login/token'; // CAMBIA ESTA URL
                    // =================================================================

                    const response = await fetch(LOGIN_API_ENDPOINT_URL, {
                        method: 'POST',
                        headers: {
                            // Para OAuth2PasswordRequestForm, el Content-Type es 'application/x-www-form-urlencoded'
                            'Content-Type': 'application/x-www-form-urlencoded',
                            // 'Accept': 'application/json', // Aún esperamos una respuesta JSON con el token
                        },
                        body: bodyData // Usar URLSearchParams para el body
                    });

                    // --- 4. Manejar la respuesta del backend ---
                    if (response.ok) {
                        const result = await response.json(); // El backend debería devolver { "access_token": "...", "token_type": "bearer" }
                        
                        // =================================================================
                        // MODIFICAR AQUÍ: Cómo manejas una respuesta exitosa y el token.
                        // 'result' contendrá el token de acceso.
                        console.log('Login exitoso. Token:', result);
                        
                        // Guardar el token (ej. en localStorage)
                        if (result.access_token) {
                            localStorage.setItem('accessToken', result.access_token);
                            localStorage.setItem('tokenType', result.token_type || 'bearer');

                            messageArea.textContent = 'Inicio de sesión exitoso. Redirigiendo...';
                            messageArea.classList.add('text-green-700', 'font-semibold');
                            
                            // Redirigir a la página principal o dashboard después de un breve retraso
                            // CAMBIA '/dashboard.html' a tu página de destino
                            setTimeout(() => {
                                window.location.href = '/dashboard.html'; // O la URL de tu formulario de mantenimiento
                            }, 1500);

                        } else {
                            throw new Error("Token no recibido del servidor.");
                        }
                        // =================================================================
                    
                    } else { // Error de autenticación (ej. 400, 401) u otro error
                        let errorMessage = `Error: ${response.status} ${response.statusText}`;
                        try {
                            const errorResult = await response.json();
                            // =================================================================
                            // MODIFICAR AQUÍ: Cómo extraes el mensaje de error de la respuesta.
                            // FastAPI con OAuth2 suele devolver { "detail": "Incorrect username or password" }
                            errorMessage = errorResult.detail || errorResult.message || JSON.stringify(errorResult);
                            // =================================================================
                        } catch (e) {
                            // Si la respuesta de error no es JSON.
                            const textError = await response.text();
                            if (textError) errorMessage = textError;
                        }
                        console.error('Error de login:', errorMessage);
                        messageArea.textContent = errorMessage;
                        messageArea.classList.add('text-red-600', 'font-semibold');
                    }

                } catch (error) { // Errores de red u otros
                    console.error('Error en la petición de login:', error);
                    messageArea.textContent = 'Error de conexión o al procesar el inicio de sesión.';
                    messageArea.classList.add('text-red-600', 'font-semibold');
                } finally {
                    // --- 5. Restaurar estado del botón (solo si no hay redirección inmediata) ---
                    // Si hay redirección, no es estrictamente necesario, pero es buena práctica.
                    if (!localStorage.getItem('accessToken')) { // Solo si no se logró el login
                        loginButton.disabled = false;
                        buttonText.textContent = 'Iniciar Sesión';
                        buttonSpinner.classList.add('hidden');
                    }
                }
            });
        });
    </script>
</body>
</html>